---
title: 'Data Steps'
date: '`r format(Sys.time(), "%B %d, %Y")`'
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    highlight: tango
    df_print: paged
    includes:
      after_body: 'footer.html'
---

# Tutorial on cleaning the LTDB 

## Background
As is mentioned in the [Week 02 lab instructions](lab-02-instructions.html), this course will be using the Longitudinal Tracts Data Base (LTDB) for over-time analysis with census data. This is a great resource for communities because the researchers harmonized 40 years of census data by apportioning old data so it fits the new 2010 census tracts and allows for analysis of consistent geographic units over time. 

## Challenge
Unfortunately the data is not ready to be used right away thus requiring us to clean it beforehand. The challenge is we need to restructure the input census datasets to enable us to fully utilize the over-time aspects of the data.

## Goal
The following chunks depend on you having clean data in your `data/rodeo` folder. These files are generated by making local copies of two `.R` files that power this tutorial.

## Make two local copies of the two `.R` files

This HTML file is meant for you to view the data cleaning steps in the browser. However, you need the files produced by the following two `.R` files for future labs so please read the direction below carefully.

To create the necessary files for future labs, follow these steps:

1. [Download a local copy of the `labs/utilities.R` file](utilities.R);
2. Save the file as `labs/wk03/utilities.R`.
3. [Download a local copy the `labs/project_data_steps.R` file](project_data_steps.R);
4. Save the file as `labs/wk03/project_data_steps.R`.
5. Select all the lines within the `labs/wk03/project_data_steps.R` and run them all to produce all of the clean data files within `data/rodeo`.


```{r setup, include=FALSE}
knitr::opts_chunk$set( echo=TRUE, message=F, warning=F, eval=T )
```

With all that said, let's get started on cleaning the LTDB!

## Start Tutorial

```{r load necessary packages, message=FALSE}
# load necessary packages ----
library( dplyr )
library( here )
library( knitr )
library( pander )
```

## Heads up: new `import::here()` method 

Last week, you should have stored all your functions in a file called `utilities.R`. This file probably had a lot more objects than the three functions you were meant to create.

Storing more objects in your `utilities.R` file than are used is normal. However, you should always be more explicit about what you are loading into the Global Environment.

When you used `source(here::here("some/file.R"))`, you are telling R to load **every** object into the Global Environment. Moving forward, you will not be using the `source()` function for this exact reason: it over populates the Global Environment.

### Introducing `import::here` function

The `import::here()` works nearly the same as the `source()` function with the added bonus that you get to declare **specific** objects you would like to be made available within the Global Environment.

This is best practice because no the Global Environment will only contain the necessary objects rather than every object that was created within your `.R` file.

### `import::here` will be needed in every lab from here on out

The reason why `import::here` is required for every lab from here on out is for two reasons:

1. For you to grow the skill of separating source code from your `.rmd` files; and
2. For you to grow the skill of scaling your work.

I have no doubt that the first skill will be a growing pain for all of you. However, it will nearly always be the case that your supervisor will be more interested in the **output of your file** than _how_ the output was generated.

A great supervisor will be interested in both; however, you should gain experience separating R logic in a different file and importing into your `.rmd` files. Additionally, it makes it much easier to forward a GitHub link to a `.R` file when someone else on your team needs to familiarize themselves with code rather than sending them a `.rmd` file.

The second skill, however, will become readily apparent in the next few labs. You'll learn to minimize copying and pasting logic and instead rely on `import::here()` to not only save you time, but allow you to begin to use inline R code to dynamically embed within the narrative portion of your `.rmd` files.

With that said, here is the rest of the tutorial that uses `import::here()`.

```{r import specific functions}
# import specific functions
# note: all of these are R objects that will be used throughout this .rmd file
import::here("clean_d",
             "tidy_up_data",
             "build_year",
             "RELEVANT_FILES",
             "obtain_crosswalk",
             "create_final_metadata_file",
             # notice the use of here::here() that points to the .R file
             # where all these R objects are created
             .from = here::here("labs/utilities.R"),
             .character_only = TRUE)
```

# Inspect Data

First, let's inspect the raw data. *Note: please do not import files using static file paths. Notice the use of `here::here()` down below.*


## Check 2010 Data

```{r check 2010 data}
# load all data as character vecs
d.2010.samp <- read.csv( here::here("data/raw/ltdb_std_2010_sample.csv"),
                         colClasses="character" )
str( d.2010.samp[1:10] )
```

Check 2010 summary stats: 

```{r check 2010 summary stats}
head( d.2010.samp$p65hsp12 ) # missing values coded as -999
sum( d.2010.samp$p65hsp12 == "-999" )
summary( as.numeric(d.2010.samp$p65hsp12) )
```

We have problems with missing data coded as `-999`, which will cause issues with any analysis. 

## Remove Missing Value Codes

Remove missing value codes `-999` and replace with variable mean or NAs. 

Test the code: 

```{r test the clean_d() function}
# first four columns are unique IDs - leave them as character vectors
d.2010.samp <- clean_d( d.2010.samp, start_column=5 )

str( d.2010.samp[1:10] )

summary( d.2010.samp$p65hsp12 ) %>% pander()
```


That works!

# Tidy Up Dataframes

We want to standardize datasets across all of the years so that they are all clean, have the same structure, same variable name conventions, etc. 


Test code: 

The following is set to `eval=FALSE` because it's not required for you to generate the final outputs.

*Note: `tidy_up_data()` is able to read in the data because it is not importing files using static file paths.* 

```{r test tidy_up_data() function, eval=F}
file.name <- "ltdb_std_2010_sample.csv"
d.2010.s <- tidy_up_data( file.name )
head( d.2010.s[1:20] ) %>% pander()

file.name <- "LTDB_Std_2010_fullcount.csv"
d.2010.f <- tidy_up_data( file.name )
head( d.2010.f[1:20] ) %>% pander()

d2 <- bind_rows( d.2010.s, d.2010.f )


file.name <- "ltdb_std_2000_sample.csv"
d.2010.s <- tidy_up_data( file.name )
head( d.2010.s[1:20] ) %>% pander()

file.name <- "LTDB_Std_2000_fullcount.csv"
d.2010.f <- tidy_up_data( file.name )
head( d.2010.f[1:20] ) %>% pander()

d2 <- bind_rows( d.2010.s, d.2010.f )
```


Clean and tidy all data from the same year, then combine sample and full dataframes into a single table. *Notice the use of `here::here()` down below can also be used when telling R where to save a file.*

```{r create build_year() function to tidy data across the years}
# for each relevant file, run the build_year() function
# note: this populates the data/rodeo/ directory with clean files
for (relevant_file in RELEVANT_FILES) {
  print(paste0("Starting on ", relevant_file[["year"]]))
  build_year(fn1 = relevant_file[["fullcount"]],
             fn2 = relevant_file[["sample"]],
             year = relevant_file[["year"]])
  if (relevant_file[["year"]] < 2010) {
    print("Finished! Moving onto the next decade.")
  } else {
    print("Finished! No more data to parse.")
  }
  
}
```


Check a file: 

*Note: Notice the use of `here::here()` below when importing data.*

```{r check one of the output files}
# import the clean file 
d <- readRDS( here::here( "data/rodeo/LTDB-2000.rds" ) )
head( d ) %>% pander()
```


# Metro Area Metadata

Metro areas are designated by the US Census as Core-Based Statistical Areas (CBSA). 

"A core-based statistical area (CBSA) is a U.S. geographic area defined by the Office of Management and Budget (OMB) that consists of one or more counties (or equivalents) anchored by an urban center of at least 10,000 people plus adjacent counties that are socioeconomically tied to the urban center by commuting. Areas defined on the basis of these standards applied to Census 2000 data were announced by OMB in June 2003. These standards are used to replace the definitions of metropolitan areas that were defined in 1990. The OMB released new standards based on the 2010 Census." [cite](https://en.wikipedia.org/wiki/Core-based_statistical_area)

Note that these are defined as sets of counties, so the definition files are organized with one county per row, and attributes associated with the county. 

Census data files do not always have info about metro areas. If we need this information for our analysis we can get a crosswalk file from the National Bureau of Economic Research: 

https://data.nber.org/data/cbsa-msa-fips-ssa-county-crosswalk.html

*Note: Notice the absence of `here::here()`. It is not necessary here because the file lives outside of our directory.*

```{r import FIPS-CBSA crosswalk}
# load the crosswalk
# note: this stores a copy in the data/raw/ directory
cw <- obtain_crosswalk()

# view all metro areas in the country
sort( unique( cw$cbsaname ) ) %>% head() %>% pander()
```

There are 3,292 counties in 2010. Of these, 35% are urban, 65% are rural. 

```{r count rural v. urban}
# note in the data dictionary for CBSA Name (copied below): “blanks are rural”
table( cw$urban ) %>% pander()
```


It's not technically not strictly raw data because we created a new variable and dropped some columns, but it's input data we are grabbing from an external site as meta-data, and it will not be a final research dataset used for analysis, so we can put it into the raw folder. 



```
# DATA DICTIONARY FOR CROSSWALK

  1.  cbsatocountycrosswalk2005 set up by Jean Roth , jroth@nber.org , 20 Dec 2016
  2.  Source: fr05_cbsa_msa_xwalk_pub.txt
  3.  NBER URL: http://www.nber.org/data/cbsa-msa-fips-ssa-county-crosswalk.html
  4.  Source Page: http://www.cms.gov/Medicare/Medicare-Fee-for-Service-Payment/AcuteInpatientPPS/Acute-Inpatient-Files-for-Download-Items/CMS022637.html
  5.  Source File URL: http://www.cms.gov/Medicare/Medicare-Fee-for-Service-Payment/AcuteInpatientPPS/Downloads/fr05_cbsa_msa_xwalk_pub.zip
  6.  by Jean Roth , jroth@nber.org , 28 Nov 2016

ssacounty:
  1.  Los Angeles FIPS 06037 can have two SSA county codes: 05210 and 05200

  obs:         3,293                          
 vars:            21                          20 Dec 2016 11:41
 size:       757,390                          (_dta has notes)
-----------------------------------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-----------------------------------------------------------------------------------------------------------
countyname      str26   %26s                  County Name
state           str2    %9s                   State
ssacounty       str5    %9s                 * SSA County Code
fipscounty      str5    %9s                   FIPS County Code
msa             str6    %9s                   Old MSA
l               str1    %9s                   Lugar
msaname         str48   %48s                  Old MSA Name
cbsa            str5    %9s                   CBSA - if blank then rural area (set equal to first 2 digits of ssa code)
cbsaname        str50   %50s                  CBSA Name
cbsaold         long    %12.0g                 (Blanks are Rural)
cbsanameold     str42   %42s                   (Blanks are Rural)
ssast           str2    %9s                   SSA State code
fipst           str2    %9s                   FIPS State code
y2005           float   %9.0g                 Present in 2005 source file
y2011           float   %9.0g                 Present in 2011 source file
y2012           float   %9.0g                 Present in 2012 source file
y2013           float   %9.0g                 Present in 2013 source file
y2014           float   %9.0g                 Present in 2014 source file
y2015           float   %9.0g                 Present in 2015 source file
y2016           float   %9.0g                 Present in 2016 source file
y2017           float   %9.0g                 Present in 2017 source file
                                            * indicated variables have notes
------------------------------------------------------------------------------------------------------------
Sorted by: fipscounty  ssacounty
```


<br>

-----


<br>



# Create Meta-Data Table

Each of the file contains redundant meta-data. We can remove it to make merges easier, and consolidate all of the meta-data (attributes of counties and census tracts) into a single file for ease of use. 

We need one per year from 1980 to 2000 to grab all of the unique meta-data in the files. 

```{r create metadata table}
# create the final meta data file
# note: this stores a copy within the data/rodeo/ directory
create_final_metadata_file(file_names = RELEVANT_FILES,
                           crosswalk = cw)

# view the results
md_complete = readr::read_rds(here::here("data/rodeo/LTDB-META-DATA.rds"))
pander::pander(head(md_complete))
```

<br>
<br>

<hr>

<br>
<br>
<br>


# Alternative Approach 

Build one large stacked dataset:

Hard to use because you don't know which panel years exist for each variable. 

```{r, eval=F}
d.list <- NULL
loop.count <- 1

for( i in these )
{
  file.name <- i
  d.i <- tidy_up_data( file.name )
  d.list[[ loop.count ]] <- d.i
  loop.count <- loop.count + 1
}

d <- bind_rows( d.list )
```





Then you can reshape the dataset as needed:

```{r, eval=F}

dat <- dplyr::filter( dat, year %in% c(2000,2010) )

library(data.table)   # CRAN version 1.10.4
setDT(world)   # coerce to data.table
data_wide <- dcast(world, Country ~ Year, 
                   value.var = c("Growth", "Unemployment", "Population"))

reshape(world, direction = "wide", timevar = "Year", idvar = "Country")

d2 <- d[1:20]

reshape( d2, direction="wide", timevar="year", idvar="tractid" )
```





```
+---------+------+--------+--------------+------------+
| Country | Year | Growth | Unemployment | Population |
+---------+------+--------+--------------+------------+
| A       | 2015 |      2 |          8.3 |         40 |
| B       | 2015 |      3 |          9.2 |         32 |
| C       | 2015 |    2.5 |          9.1 |         30 |
| D       | 2015 |    1.5 |          6.1 |         27 |
| A       | 2016 |      4 |          8.1 |         42 |
| B       | 2016 |    3.5 |            9 |       32.5 |
| C       | 2016 |    3.7 |            9 |         31 |
| D       | 2016 |    3.1 |          5.3 |         29 |
| A       | 2017 |    4.5 |          8.1 |       42.5 |
| B       | 2017 |    4.4 |          8.4 |         33 |
| C       | 2017 |    4.3 |          8.5 |         30 |
| D       | 2017 |    4.2 |          5.2 |         30 |
+---------+------+--------+--------------+------------+
  
  +---------+-------------+-------------------+-----------------+-------------+-------------------+-----------------+
| Country | Growth_2015 | Unemployment_2015 | Population_2015 | Growth_2016 | Unemployment_2016 | Population_2016 |
+---------+-------------+-------------------+-----------------+-------------+-------------------+-----------------+
| A       |           2 |               8.3 |              40 |           4 |               8.1 |              42 |
| B       |           3 |               9.2 |              32 |         3.5 |                 9 |            32.5 |
| C       |         2.5 |               9.1 |              30 |         3.7 |                 9 |              31 |
| D       |         1.5 |               6.1 |              27 |         3.1 |               5.3 |              29 |
+---------+-------------+-------------------+-----------------+-------------+-------------------+-----------------+

```




<br>
<br>

<hr>

<br>
<br>






<style>
blockquote {
    padding: 11px 22px;
    margin: 0 0 22px;
    font-size: 18px;
    border-left: 5px solid lightgray;
}

</style>

